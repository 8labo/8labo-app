<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>8LABO ACADEMY</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #fcfdfe; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input, select { 
            width: 100%; border-radius: 1rem; border: 2px solid #e2e8f0 !important; 
            padding: 1rem !important; font-weight: bold !important; 
            background: white !important; color: #1e293b !important; font-size: 16px !important; 
        }
        input:focus { border-color: #005bac !important; outline: none; }
        .btn-primary { background: #005bac; color: white; font-weight: 900; padding: 1.2rem; border-radius: 1.2rem; width: 100%; box-shadow: 0 10px 20px -5px rgba(0,91,172,0.3); }
        .btn-accent { background: #f39800; color: white; font-weight: 900; padding: 1.2rem; border-radius: 1.2rem; width: 100%; box-shadow: 0 10px 20px -5px rgba(243,152,0,0.3); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- æœ¬ç•ªURLï¼šè¨­å®šæ¸ˆã¿ ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyjtyoFK3qAVQsCsxAGClfy1WIGA7F6vSZgZdkBsG0N1T9PCW49H3O0PlN5J7wlkmlnRA/exec"; 

        const Icon = ({ name }) => {
            const icons = {
                ChevronLeft: <polyline points="15 18 9 12 15 6"/>,
                // è¤‡æ•°ã®è¦ç´ ã¯ <g> ã‚¿ã‚°ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
                CheckCircle: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></g>,
                Lock: <g><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></g>,
                Home: <g><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></g>
            };
            return (
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                    {icons[name] || null}
                </svg>
            );
        };

        const App = () => {
            const [view, setView] = useState('login'); 
            const [studentInfo, setStudentInfo] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const [loginId, setLoginId] = useState("");
            const [loginPass, setLoginPass] = useState("");
            const [regForm, setRegForm] = useState({ name: "", kana: "", school: "", grade: "å°å­¦1å¹´", email: "" });
            const [regResult, setRegResult] = useState(null);
            const [newPass, setNewPass] = useState("");

            const handleLogin = async (e) => {
                if (e) e.preventDefault();
                setIsSubmitting(true);
                try {
                    const resp = await fetch(`${GAS_URL}?action=getStudent&id=${loginId.trim()}&pass=${loginPass.trim()}`);
                    const data = await resp.json();
                    if (data.status === "success") {
                        setStudentInfo(data.student);
                        if (data.student.isFirstLogin) setView('first-pass');
                        else setView('home');
                    } else { alert(data.message); }
                } catch (err) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼šGASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãŒã€Œå…¨å“¡(Anyone)ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); }
                finally { setIsSubmitting(false); }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                try {
                    const query = new URLSearchParams({ action: 'registerVisitorDetail', ...regForm }).toString();
                    const resp = await fetch(`${GAS_URL}?${query}`);
                    const data = await resp.json();
                    if (data.status === "success") {
                        setRegResult(data);
                        setView('reg-success');
                    }
                } catch (err) { alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼"); }
                finally { setIsSubmitting(false); }
            };

            const handlePassChange = async (e) => {
                e.preventDefault();
                if (newPass.length < 6 || newPass.length > 12) { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6ã€œ12æ–‡å­—ã§è¨­å®šã—ã¦ãã ã•ã„"); return; }
                setIsSubmitting(true);
                try {
                    const resp = await fetch(`${GAS_URL}?action=changePassword&id=${studentInfo.id}&newPass=${newPass}`);
                    const data = await resp.json();
                    if (data.status === "success") {
                        alert("è¨­å®šå®Œäº†ï¼æœ¬ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ›ãƒ¼ãƒ ã¸é€²ã¿ã¾ã™ã€‚");
                        setView('home');
                    }
                } catch (err) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); }
                finally { setIsSubmitting(false); }
            };

            return (
                <div className="w-full max-w-[400px] mx-auto min-h-screen bg-[#fcfdfe] flex flex-col relative overflow-hidden shadow-2xl">
                    
                    {view === 'login' && (
                        <div className="flex-1 p-10 bg-[#005bac] flex flex-col items-center justify-center text-white animate-in">
                            <div className="w-20 h-20 bg-white rounded-[1.8rem] flex items-center justify-center mb-6 shadow-2xl rotate-3 text-[#005bac] font-black text-4xl italic text-center">8</div>
                            <h1 className="text-2xl font-black mb-10 italic uppercase tracking-tighter text-center">8LABO ACADEMY</h1>
                            <form onSubmit={handleLogin} className="w-full space-y-4">
                                <input type="text" placeholder="ID" value={loginId} onChange={e=>setLoginId(e.target.value)} required />
                                <input type="password" placeholder="PASSWORD" value={loginPass} onChange={e=>setLoginPass(e.target.value)} required />
                                <button type="submit" disabled={isSubmitting} className="btn-accent uppercase italic">{isSubmitting ? "AUTH..." : "LOGIN"}</button>
                                <button type="button" onClick={() => setView('register')} className="w-full text-[11px] font-black text-white/60 uppercase tracking-widest pt-6">æ–°è¦ç™»éŒ²ï¼ˆåˆã‚ã¦ã®æ–¹ï¼‰</button>
                            </form>
                        </div>
                    )}

                    {view === 'register' && (
                        <div className="flex-1 p-8 pt-16 bg-white animate-in overflow-y-auto">
                            <div className="flex items-center gap-4 mb-8">
                                <button onClick={() => setView('login')} className="p-2 text-slate-300"><Icon name="ChevronLeft" /></button>
                                <h2 className="text-2xl font-black text-slate-800 italic uppercase">Visitor Registration</h2>
                            </div>
                            <form onSubmit={handleRegister} className="space-y-5 pb-10">
                                <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-2">ãŠåå‰ï¼ˆæ¼¢å­—ãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰</label>
                                <input type="text" placeholder="å…«ãƒ©ãƒœ å¤ªéƒ" value={regForm.name} onChange={e=>setRegForm({...regForm, name: e.target.value})} required /></div>
                                <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-2">ãµã‚ŠãŒãª</label>
                                <input type="text" placeholder="ã¯ã¡ã‚‰ã¼ ãŸã‚ã†" value={regForm.kana} onChange={e=>setRegForm({...regForm, kana: e.target.value})} required /></div>
                                <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-2">å­¦æ ¡å</label>
                                <input type="text" placeholder="ã€‡ã€‡å°å­¦æ ¡" value={regForm.school} onChange={e=>setRegForm({...regForm, school: e.target.value})} required /></div>
                                <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-2">å­¦å¹´</label>
                                <select value={regForm.grade} onChange={e=>setRegForm({...regForm, grade: e.target.value})}>
                                    <option>æœªå°±å­¦</option><option>å°å­¦1å¹´</option><option>å°å­¦2å¹´</option><option>å°å­¦3å¹´</option>
                                    <option>å°å­¦4å¹´</option><option>å°å­¦5å¹´</option><option>å°å­¦6å¹´</option>
                                    <option>ä¸­å­¦1å¹´</option><option>ä¸­å­¦2å¹´</option><option>ä¸­å­¦3å¹´</option><option>é«˜æ ¡ç”Ÿä»¥ä¸Š</option>
                                </select></div>
                                <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" placeholder="contact@8labo.jp" value={regForm.email} onChange={e=>setRegForm({...regForm, email: e.target.value})} required /></div>
                                <button type="submit" disabled={isSubmitting} className="btn-primary uppercase mt-4 italic">{isSubmitting ? "SENDING..." : "è¦ç´„ã«åŒæ„ã—ã¦ç™»éŒ²"}</button>
                            </form>
                        </div>
                    )}

                    {view === 'reg-success' && (
                        <div className="flex-1 p-10 flex flex-col items-center justify-center animate-in text-center bg-white">
                            <div className="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mb-8 shadow-inner"><Icon name="CheckCircle" /></div>
                            <h2 className="text-2xl font-black text-slate-800 mb-2 italic uppercase leading-none">Register Success!</h2>
                            <p className="text-slate-400 font-bold text-[10px] mb-10 tracking-widest">IDã¨ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã—ã¾ã—ãŸ</p>
                            <div className="w-full bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100 space-y-6 mb-10 shadow-inner">
                                <div><p className="text-[10px] font-black text-slate-300 uppercase mb-1">Your ID</p><p className="text-3xl font-black text-[#005bac] tracking-tighter">{regResult.id}</p></div>
                                <div className="h-px bg-slate-200 w-1/2 mx-auto"></div>
                                <div><p className="text-[10px] font-black text-slate-300 uppercase mb-1">Temp Password</p><p className="text-2xl font-black text-slate-800 tracking-tighter">{regResult.tempPass}</p></div>
                            </div>
                            <p className="text-[11px] text-slate-400 font-medium mb-8 leading-relaxed italic px-4">â€»ã“ã®ç”»é¢ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br/>ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«æœ¬ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¸ã®å¤‰æ›´ãŒå¿…è¦ã§ã™ã€‚</p>
                            <button onClick={() => { setLoginId(regResult.id); setLoginPass(regResult.tempPass); setView('login'); }} className="btn-primary">ãƒ­ã‚°ã‚¤ãƒ³ã¸é€²ã‚€</button>
                        </div>
                    )}

                    {view === 'first-pass' && (
                        <div className="flex-1 p-10 flex flex-col items-center justify-center animate-in bg-white">
                            <div className="bg-blue-50 text-blue-600 p-5 rounded-3xl mb-8 shadow-sm text-center flex justify-center"><Icon name="Lock" /></div>
                            <h2 className="text-xl font-black text-slate-800 mb-2 italic uppercase">Security Required</h2>
                            <p className="text-slate-400 font-bold text-[10px] mb-8 tracking-widest text-center leading-relaxed">
                                {studentInfo.name} æ§˜ã€ã‚ˆã†ã“ãã€‚<br/>åˆå›ã®ãŸã‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æœ¬è¨­å®šã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
                            </p>
                            <form onSubmit={handlePassChange} className="w-full space-y-4">
                                <input type="password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6ã€œ12æ–‡å­—ï¼‰" value={newPass} onChange={e=>setNewPass(e.target.value)} required />
                                <button type="submit" disabled={isSubmitting} className="btn-primary italic">{isSubmitting ? "æ›´æ–°ä¸­..." : "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºå®šã™ã‚‹"}</button>
                            </form>
                        </div>
                    )}

                    {view === 'home' && (
                        <div className="flex-1 flex flex-col animate-in bg-[#fcfdfe]">
                            <header className="bg-[#005bac] text-white p-8 pt-12 pb-10 shadow-md flex justify-between items-center shrink-0">
                                <h1 className="text-xl font-black tracking-tighter italic uppercase">8LABO ACADEMY</h1>
                                <button onClick={() => setView('login')} className="p-2 opacity-50"><Icon name="Home" /></button>
                            </header>
                            <main className="flex-1 p-6 space-y-6">
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-xl flex items-center gap-5 border border-white">
                                    <div className="w-14 h-14 bg-gradient-to-br from-blue-50 to-slate-50 rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-slate-50">ğŸ‘¤</div>
                                    <div><h2 className="font-black text-xl text-slate-800 leading-none">{studentInfo.name} æ§˜</h2><p className="text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-widest">ID: {studentInfo.id}</p></div>
                                </div>
                                <div className="p-10 bg-slate-100 rounded-[3rem] text-center border-2 border-dashed border-slate-200 mt-10">
                                    <Icon name="CheckCircle" />
                                    <p className="text-xs font-bold text-slate-400 leading-relaxed uppercase tracking-widest mt-4">
                                        èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br/>ç¾åœ¨ã€æœ¬ç•ªé‹ç”¨ã«å‘ã‘ã¦æº–å‚™ä¸­ã§ã™ã€‚
                                    </p>
                                </div>
                            </main>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
